import{j as e}from"./mui-vendor-DRsyA_VI.js";import{a as t}from"./react-vendor-CP5_hn_0.js";import{C as n,O as o,S as i,B as s,a as r,T as a,M as c,b as l,F as d,G as u,V as h,c as g,d as f,e as p,f as w,Q as y,g as m}from"./three-vendor-C8Ar5e6p.js";import"./chart-vendor-BJu2iTGG.js";const b={core:"#ffffff",firewall:"#e55353",router:"#f6a609",l3switch:"#f6a609",switchrouter:"#f6a609",layer3:"#f6a609",switch:"#3fb950",hub:"#26c6da",server:"#6aa7ff",host:"#6aa7ff",default:"#a0b4ff"};function k({zone:k,onBack:S,onInspectorChange:v,setEventLogs:x}){const _=t.useRef(),D=t.useRef(null),[j,z]=t.useState({nodes:[],links:[]}),[C,I]=t.useState(!1),[L,P]=t.useState(null),[M,O]=t.useState({width:0,height:0});t.useEffect(()=>{if(null==k)return;let e=!0;return(async()=>{try{I(!0);const t=await fetch(`http://localhost:8000/neo4j/nodes?activeView=zone${k}`),n=await t.json(),o=new Map,i=[];n.forEach(e=>{e.src_IP?.id&&o.set(String(e.src_IP.id),e.src_IP),e.dst_IP?.id&&o.set(String(e.dst_IP.id),e.dst_IP),e.edge?.sourceIP&&e.edge?.targetIP&&i.push({source:String(e.edge.sourceIP),target:String(e.edge.targetIP),...e.edge})});const s=new Set([...o.keys()]),r=i.filter(e=>s.has(e.source)&&s.has(e.target)),a=new Set,c=[];for(const e of r){const t=String(e.source),n=String(e.target),o=t<n?`${t}__${n}__${e.type||""}`:`${n}__${t}__${e.type||""}`;a.has(o)||(a.add(o),c.push(e))}const l=Array.from(o.values()).map(e=>{const t=(e.kind||e.type||"host").toLowerCase(),n=e.label||e.ip||String(e.id),o=e.color||b[t]||b.default,i=e.status||"up",s=e.subnet?e.subnet:"string"==typeof e.ip&&e.ip.includes(".")?e.ip.split(".").slice(0,3).join(".")+".0/24":"unknown/24",r=Number.isFinite(e.zone)?e.zone:null;return{...e,id:String(e.id),kind:t,label:n,color:o,status:i,subnet:s,zone:r}});e&&z({nodes:l,links:c})}catch(t){e&&z({nodes:[],links:[]})}finally{e&&I(!1)}})(),()=>{e=!1}},[k]);const E=t.useMemo(()=>({torus:new a(7,1.6,16,32),cone:new r(4.2,9,10),cylinder:new n(4.2,4.2,8,18),box:new s(8.2,2.6,6.2),l3top:new n(2.8,2.8,2.2,16),sphere:new i(3,16,16),led:new i(.7,8,8),hit:new i(7,8,8),octa:new o(4.2,0),dashUnit:new n(1,1,1,10)}),[]),A=t.useMemo(()=>({base:new Map,highlight:new c({color:16767609,metalness:.25,roughness:.72}),dim:new c({color:3293269,metalness:.25,roughness:.72}),ledUp:new l({color:65433}),ledDown:new l({color:16724821}),hit:new l({opacity:0,transparent:!0,depthWrite:!1}),dashedBase:new c({color:8891132,metalness:.15,roughness:.6,transparent:!0,opacity:.98,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-1}),dashedInc:new c({color:3829730,metalness:.2,roughness:.55,transparent:!0,opacity:1,depthWrite:!1,polygonOffset:!0,polygonOffsetFactor:-1})}),[]);function $(e){try{e.renderOrder=10,e.material&&(e.material.depthWrite=!1,e.material.polygonOffset=!0,e.material.polygonOffsetFactor=-1)}catch(t){}}function B(e,t,n,o){const i=(new h).subVectors(n,t),s=i.length();if(s<1e-6)return void(e.visible=!1);e.visible=!0;const r=(new h).addVectors(t,n).multiplyScalar(.5);e.position.copy(r),e.quaternion.setFromUnitVectors(new h(0,1,0),i.clone().normalize()),e.scale.set(o,s,o)}const T=e=>{e=String(e||"");let t=0;for(let n=0;n<e.length;n++)t=131*t+e.charCodeAt(n)>>>0;return t};function V(e,t){const n=e.source&&"object"==typeof e.source?e.source:j.nodes.find(t=>String(t.id)===String(e.source)),o=e.target&&"object"==typeof e.target?e.target:j.nodes.find(t=>String(t.id)===String(e.target));if(!n||!o)return void(t.visible=!1);const i=new h(n.x||0,n.y||0,n.z||0),s=new h(o.x||0,o.y||0,o.z||0),r=e=>{if(!e)return 3;const t=e.__deg||0;return 3*("core"===e.kind?1.4:Math.max(.9,Math.min(1.8,.95+.06*t)))},a=r(n),c=r(o),l=(new h).subVectors(s,i),d=l.length()||1,u=l.clone().normalize(),f=function(e,t,n=.12,o=0){const i=(new h).subVectors(t,e),s=i.length()||1,r=(new h).addVectors(e,t).multiplyScalar(.5),a=Math.abs(i.x)<.9?new h(1,0,0):new h(0,1,0),c=(new h).crossVectors(i,a).normalize();c.applyAxisAngle(i.clone().normalize(),o);const l=n*s*2,d=c.multiplyScalar(l).add(r);return new y(e,d,t)}(i.clone().add(u.clone().multiplyScalar(Math.min(a,.4*d))),s.clone().add(u.clone().multiplyScalar(-Math.min(c,.4*d))),.12,function(e){return(T(R(e.source))+T(R(e.target)))%628/100}(e));!function(e,t,n,o,i){e.userData.dashes||(e.userData.dashes=[]);const s=e.userData.dashes;for(;s.length<16;){const t=new g(n,o);t.castShadow=!1,t.receiveShadow=!1,s.push(t),e.add(t)}for(;s.length>16;){const t=s.pop();e.remove(t),t.geometry?.dispose?.()}e.userData.matBase=o,e.userData.matInc=i}(t,0,E.dashUnit,A.dashedBase,A.dashedInc);const p=!(!L||R(e.source)!==L.id&&R(e.target)!==L.id),w=p?2.8:1.35,m=p?t.userData.matInc:t.userData.matBase,b=1/192,k=Math.min(.08,Math.max(.02,(a+c)/(4*d)));for(let h=0;h<16;h++){const e=h/16,n=Math.min(1,e+.03625),o=Math.max(0+k,e+b),i=Math.min(1-k,n-b);if(i<=o){const e=t.userData.dashes[h];e&&(e.visible=!1);continue}const s=f.getPoint(o),r=f.getPoint(i),a=t.userData.dashes[h];a&&(a.material=m,B(a,s,r,Math.max(.2,w)),$(a))}t.visible=!0}const F=t.useMemo(()=>{const e=new Map;return j.links.forEach(t=>{const n=t.source,o=t.target;e.has(n)||e.set(n,new Set),e.has(o)||e.set(o,new Set),e.get(n).add(o),e.get(o).add(n)}),e},[j]),R=e=>e&&"object"==typeof e?e.id??e.__id??String(e):String(e),W=e=>L&&(R(e.source)===L.id||R(e.target)===L.id);return t.useEffect(()=>{if(!L||!x)return;const e=F.get(L.id)||new Set,t=Array.from(e).map(e=>{const t=j.nodes.find(t=>t.id===e);return t?.ip}).filter(e=>e),n=j.links.filter(e=>{const t="object"==typeof e.source?e.source.id:e.source,n="object"==typeof e.target?e.target.id:e.target;return t===L.id||n===L.id}).map(e=>{const t="object"==typeof e.source?e.source.id:e.source,n="object"==typeof e.target?e.target.id:e.target,o=j.nodes.find(e=>e.id===t),i=j.nodes.find(e=>e.id===n);return{src_IP:o?{id:o.id,ip:o.ip,subnet:o.subnet,gateway:o.gateway,__labels:[o.kind],__id:o.id,index:o.zone}:null,dst_IP:i?{id:i.id,ip:i.ip,subnet:i.subnet,gateway:i.gateway,__labels:[i.kind],__id:i.id,index:i.zone,__indexColor:i.color,color:i.color}:null,edge:{sourceIP:t,targetIP:n,type:e.type,count:e.count}}}),o={message:`Zone ${k} - 노드 선택: ${L.label||L.id}`,nodeInfo:{label:L.label,kind:L.kind,ip:L.ip,subnet:L.subnet,zone:L.zone,id:L.id},connectedCount:e.size,connectedIps:t,dbInfo:n};x([o])},[L,F,j.nodes,j.links,k,x]),t.useEffect(()=>{const e=()=>{try{_.current&&_.current.zoomToFit(600,40)}catch{}};(j.nodes?.length||j.links?.length)&&requestAnimationFrame(e);const t=D.current;let n;return t&&"undefined"!=typeof ResizeObserver?(n=new ResizeObserver(()=>{requestAnimationFrame(e)}),n.observe(t)):window.addEventListener("resize",e),()=>{n&&t&&n.unobserve(t),window.removeEventListener("resize",e)}},[j]),t.useEffect(()=>{const e=D.current;if(!e)return;const t=()=>{try{O({width:e.clientWidth||0,height:e.clientHeight||0})}catch{}};let n;if(t(),"undefined"!=typeof ResizeObserver){n=new ResizeObserver(()=>t());try{n.observe(e)}catch{}}else window.addEventListener("resize",t);return()=>{try{n&&e&&n.unobserve(e)}catch{}window.removeEventListener("resize",t)}},[]),e.jsx("div",{style:{width:"100%",height:"100%",background:"transparent",padding:0},children:e.jsxs("div",{style:{flex:1,position:"relative",background:"#181c23",borderRadius:12,overflow:"hidden",height:"100%"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:12,marginBottom:14,padding:24},children:[e.jsx("button",{onClick:S,style:{background:"transparent",border:"none",color:"#93c5fd",cursor:"pointer",fontSize:14},children:"← Back"}),e.jsx("h2",{style:{fontSize:22,fontWeight:700,margin:0,color:"#fff"},children:`Zone ${k}`}),e.jsx("div",{style:{color:"#cbd5e1"},children:C?"Loading…":`${j.nodes.length} nodes • ${j.links.length} links`})]}),e.jsx("div",{ref:D,style:{height:"calc(100% - 80px)",position:"relative"},children:e.jsx(d,{ref:_,graphData:j,backgroundColor:"#181c23",width:M.width,height:M.height,nodeLabel:null,nodeThreeObject:function(e){const t=new u,n=e.color||"#a0b4ff",o=L?(i=e,L&&(i.id===L.id||F.get(L.id)?.has(i.id))?A.highlight:A.dim):(e=>{let t=A.base.get(e);return t||(t=new c({color:new m(e),metalness:.25,roughness:.72}),A.base.set(e,t)),t})(n);var i;let s;if("core"===e.kind)s=new g(E.torus,o);else if("firewall"===e.kind)s=new g(E.cone,o);else if("router"===e.kind)s=new g(E.cylinder,o);else if("switch"===e.kind||"l2switch"===e.kind)s=new g(E.box,o);else if("l3switch"===e.kind||"switchrouter"===e.kind||"layer3"===e.kind){const e=new g(E.box,o),t=new g(E.l3top,o);t.position.y=2.6;const n=new u;n.add(e),n.add(t),s=n}else s="hub"===e.kind?new g(E.octa,o):new g(E.sphere,o);const r=1.7*("core"===e.kind?1.4:Math.max(.9,Math.min(1.8,.95+.06*(e.__deg||0))));s.scale.set(r,r,r),s.castShadow=!0,s.receiveShadow=!0,t.add(s);const a=new g(E.led,"up"===e.status?A.ledUp:A.ledDown);a.position.set(0,"core"===e.kind?13.6:6*r,0),t.add(a);const l=new g(E.hit,A.hit);if(l.name="hit-proxy",t.add(l),e.ip){const n=document.createElement("canvas"),o=n.getContext("2d");o.font="bold 18px Arial";const i=e.ip,s=o.measureText(i).width;n.width=s+16,n.height=32,o.font="bold 18px Arial",o.fillStyle="#222",o.fillRect(0,0,n.width,n.height),o.fillStyle="#fff",o.textAlign="center",o.textBaseline="middle",o.fillText(i,n.width/2,n.height/2);const a=new f(n),c=new p({map:a,transparent:!0}),l=new w(c);l.scale.set(n.width/10*1.7,n.height/10*1.7,1),l.position.set(0,"core"===e.kind?15:10*r,0),t.add(l)}return t},nodeThreeObjectExtend:!0,linkThreeObject:function(e){if("logical"!==String(e.type||"").toLowerCase())return;const t=new u;return t.userData={type:"logical-dashed",link:e,dashes:[]},t},linkThreeObjectExtend:!1,linkColor:e=>"logical"===String(e.type||"").toLowerCase()?L&&W(e)?"#3a6fe2":"#87aafc":L?W(e)?"#24a0ff":"#5b6475":"#bfc6d4",linkOpacity:e=>"logical"===String(e.type||"").toLowerCase()?L&&W(e)?1:.35:L?W(e)?.95:.08:.35,linkWidth:e=>"logical"===String(e.type||"").toLowerCase()?0:L?W(e)?6:.5:1.2,linkDirectionalParticles:e=>"logical"===String(e.type||"").toLowerCase()?0:L&&W(e)?4:0,linkDirectionalParticleWidth:e=>"logical"===String(e.type||"").toLowerCase()?0:L&&W(e)?5:0,linkDirectionalParticleSpeed:e=>"logical"===String(e.type||"").toLowerCase()?0:L&&W(e)?.006:0,linkDirectionalParticleColor:e=>"logical"===String(e.type||"").toLowerCase()?"#000000":L&&W(e)?"#00e5ff":"#000000",linkDirectionalArrowLength:e=>"logical"===String(e.type||"").toLowerCase()?0:L&&W(e)?6:0,linkDirectionalArrowRelPos:.6,linkDirectionalArrowColor:e=>"logical"===String(e.type||"").toLowerCase()?"#000000":L&&W(e)?"#00e5ff":"#000000",linkLabel:e=>{const t=R(e.source),n=R(e.target),o=j.nodes.find(e=>e.id===t),i=j.nodes.find(e=>e.id===n);return`IP: ${o&&o.ip||t} → ${i&&i.ip||n}`},enableNodeDrag:!1,showNavInfo:!1,cooldownTicks:60,d3AlphaDecay:.028,d3VelocityDecay:.35,style:{height:"100%",width:"100%"},onNodeClick:P,onBackgroundClick:()=>{P(null),x&&x([])},onLinkClick:e=>{const t=R(e.source),n=j.nodes.find(e=>e.id===t)||j.nodes[0];n&&P(n)},onLinkUpdate:(e,t)=>{try{const n=e.__lineObj||t;n&&n.computeLineDistances&&n.computeLineDistances()}catch{}},onEngineTick:()=>{const e=_.current?.scene?.();e&&e.traverse(e=>{"logical-dashed"===e.userData?.type&&e.userData.link&&V(e.userData.link,e)})},onEngineStop:()=>{const e=_.current?.scene?.();e&&e.traverse(e=>{"logical-dashed"===e.userData?.type&&e.userData.link&&(V(e.userData.link,e),e.visible=!0)})}})})]})})}export{k as default};
