import{j as e}from"./mui-vendor-DRsyA_VI.js";import{a as t,e as n}from"./react-vendor-CP5_hn_0.js";import{D as o}from"./vis-vendor-fIGJlaaL.js";import{N as s}from"./vis-network-CqERLR1V.js";function r({deviceElementId:n,onSelectDevice:r}){const d=t.useRef(null),a=t.useRef(null),[l,c]=t.useState({nodes:[],edges:[]}),[i,u]=t.useState(!1),f=t.useRef(null),h=t.useRef(null),[m,g]=t.useState({nodes:[],edges:[]}),[p,v]=t.useState(!1),[N,j]=t.useState(null),[S,y]=t.useState(null),I=n??S;return t.useEffect(()=>{fetch("/neo4j/topology").then(e=>e.json()).then(e=>{c({nodes:e.nodes||[],edges:e.edges||[]})}).catch(console.error)},[]),t.useEffect(()=>{i&&a.current&&(a.current.destroy(),a.current=null)},[i]),t.useEffect(()=>{if(!I)return g({nodes:[],edges:[]}),v(!1),void j(null);v(!0),j(null),fetch(`/neo4j/attack-graph?deviceElementId=${encodeURIComponent(I)}`).then(e=>e.json()).then(e=>{g({nodes:e.nodes||[],edges:e.edges||[],allStartNodes:new Set(e.allStartNodes||[]),targetNodeId:e.targetNodeId||null}),v(!1)}).catch(e=>{v(!1)})},[I]),t.useEffect(()=>{if(!d.current||i)return;let e,t;a.current&&(a.current.destroy(),a.current=null),e=l.nodes.map(e=>{const t=I&&e.elementId===I;return{...e,size:t?20:12,color:t?{background:"#FFCC00",border:"#CC9900"}:{background:"#2B7CE9",border:"#205AAA"}}}),t=l.edges;const n=new o(e),c=new o(t),u={nodes:n,edges:c};return a.current=new s(d.current,u,{interaction:{hover:!0,multiselect:!1},nodes:{font:{color:"#ffffff",size:10}},physics:{stabilization:!0}}),a.current.on("selectNode",e=>{const t=e.nodes&&e.nodes[0];if(!t)return;const o=n.get(t);if(null!=N&&m.allStartNodes?.has(t))j(t);else if(!N){const e=o&&o.elementId;r&&"function"==typeof r?r(e):y(e)}}),()=>{a.current&&(a.current.destroy(),a.current=null)}},[l,I,r,i,N,m]),t.useEffect(()=>{if(!f.current)return;h.current&&(h.current.destroy(),h.current=null);let e=m.nodes||[],t=m.edges||[],n=!1;if(null!=N&&m.pathsMap){const o=m.pathsMap.get(N);if(o&&o.size>0){n=!0;const s=new Set;s.add(N),s.add(m.targetNodeId);const r=[];for(const e of m.edges||[])o.has(e.id)&&(s.add(e.from),s.add(e.to),r.push(e));const d=new Map,a=[[m.targetNodeId,0]],l=new Set;for(;a.length>0;){const[e,t]=a.shift();if(!l.has(e)){l.add(e),d.set(e,t);for(const n of r)n.from!==e||l.has(n.to)?n.to!==e||l.has(n.from)||a.push([n.from,t+1]):a.push([n.to,t+1])}}t=r.map(e=>{const t=d.get(e.from)??1/0,n=d.get(e.to)??1/0;let o=e.from,s=e.to;return t<n&&(o=e.to,s=e.from),{id:e.id,from:o,to:s,arrows:"to",color:{color:"#FFD700"},width:3,title:e.title}}),e=e.filter(e=>s.has(e.id)).map(e=>e.id===N?{...e,color:{background:"#FFA500",border:"#FF8C00"},size:25}:e)}}const r=new o(e),d=new o(t),a={nodes:r,edges:d},l={interaction:{hover:!0,multiselect:!1},nodes:{font:{color:"#ffffff"}},...n?{layout:{hierarchical:{enabled:!0,direction:"DU",sortMethod:"directed",levelSeparation:150,nodeSpacing:100}}}:{},physics:{enabled:!n,stabilization:{iterations:200},barnesHut:{gravitationalConstant:-8e3,springConstant:.04,springLength:95}}};return h.current=new s(f.current,a,l),h.current.on("selectNode",e=>{const t=e.nodes&&e.nodes[0];if(!t)return;const n=r.get(t);n&&("StartPhysical"===n.group||m.allStartNodes?.has(t))&&j(t)}),()=>{h.current&&(h.current.destroy(),h.current=null)}},[m,N]),e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"attackContainer",children:[e.jsxs("div",{className:"header",children:[e.jsx("div",{children:p?"Loading attack graph...":I?`Attack target: ${I}${N?" (Start node selected)":""}`:"No attack target selected"}),N&&e.jsx("button",{onClick:()=>j(null),className:"showAllButton",children:"Show All Start Nodes"})]}),e.jsx("div",{ref:f,className:"attackGraph"})]}),i?e.jsx("div",{className:"minimizedWrapper",children:e.jsxs("button",{onClick:()=>u(!1),className:"expandButton",children:["+ ",N?"Attack Path":"Topology"]})}):e.jsxs("div",{className:"topologyPanel",children:[e.jsxs("div",{className:"topologyHeader",children:[e.jsx("span",{className:"topologyTitle",children:N?"Attack Path":"Device Topology"}),e.jsx("button",{onClick:()=>u(!0),className:"minimizeButton",children:"-"})]}),e.jsx("div",{ref:d,className:"topologyGraph"})]})]})}const d=t.memo(()=>{const t=n(),o=t.state?.selectedNode;let s=null;if(o?.dbInfo&&o.dbInfo.length>0){const e=o.dbInfo[0];s=e.dst_IP?.__element_id||e.dst_IP?.id||e.src_IP?.__element_id||e.src_IP?.id}return s||(s=o?.elementId||o?.__element_id||o?.id),e.jsx("div",{style:{height:"100vh",width:"100vw"},children:e.jsx(r,{deviceElementId:s})})});d.displayName="ResponseEffectVisualization";export{d as default};
